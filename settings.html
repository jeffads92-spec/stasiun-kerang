<!-- Ganti bagian <script> di settings.html dengan ini -->
<script>
    const user = JSON.parse(localStorage.getItem('user'));
    if (!user) window.location.href = 'index.html';

    const API_BASE = '/api';
    let settings = {};

    // Fetch All Settings
    async function fetchSettings() {
        try {
            const response = await fetch(`${API_BASE}/settings.php`);
            const result = await response.json();
            
            if (result.success) {
                settings = result.data.settings || {};
                populateSettings();
            }
        } catch (error) {
            console.error('Error fetching settings:', error);
            loadDefaultSettings();
        }
    }

    function populateSettings() {
        // Restaurant Info
        if (settings.restaurant_name) {
            document.querySelector('input[type="text"][value="Stasiun Kerang"]').value = settings.restaurant_name.value;
        }
        if (settings.restaurant_email) {
            document.querySelector('input[type="email"]').value = settings.restaurant_email.value;
        }
        if (settings.restaurant_phone) {
            document.querySelector('input[type="tel"]').value = settings.restaurant_phone.value;
        }
        
        // Tax & Service
        if (settings.tax_rate) {
            document.querySelectorAll('input[type="number"]')[0].value = parseFloat(settings.tax_rate.value) * 100;
        }
        if (settings.service_charge) {
            document.querySelectorAll('input[type="number"]')[1].value = parseFloat(settings.service_charge.value) * 100;
        }
        
        // Payment Methods
        updatePaymentMethods();
        
        // Notifications
        updateNotificationSettings();
    }

    function loadDefaultSettings() {
        settings = {
            restaurant_name: { value: 'Stasiun Kerang' },
            restaurant_email: { value: 'info@stasiun-kerang.com' },
            restaurant_phone: { value: '+62 21 1234567' },
            tax_rate: { value: '0.10' },
            service_charge: { value: '0.05' },
            payment_cash: { value: 'true' },
            payment_card: { value: 'true' },
            payment_qr: { value: 'true' },
            payment_transfer: { value: 'true' },
            notif_new_order: { value: 'true' },
            notif_low_stock: { value: 'true' },
            notif_sound: { value: 'true' }
        };
        populateSettings();
    }

    function updatePaymentMethods() {
        const paymentToggles = document.querySelectorAll('.setting-item input[type="checkbox"]');
        if (settings.payment_cash) paymentToggles[0].checked = settings.payment_cash.value === 'true';
        if (settings.payment_card) paymentToggles[1].checked = settings.payment_card.value === 'true';
        if (settings.payment_qr) paymentToggles[2].checked = settings.payment_qr.value === 'true';
        if (settings.payment_transfer) paymentToggles[3].checked = settings.payment_transfer.value === 'true';
    }

    function updateNotificationSettings() {
        const notifToggles = document.querySelectorAll('.setting-item input[type="checkbox"]');
        const offset = 4; // Skip payment toggles
        if (settings.notif_new_order) notifToggles[offset].checked = settings.notif_new_order.value === 'true';
        if (settings.notif_low_stock) notifToggles[offset + 1].checked = settings.notif_low_stock.value === 'true';
        if (settings.notif_sound) notifToggles[offset + 2].checked = settings.notif_sound.value === 'true';
    }

    // Save Restaurant Settings
    async function saveRestaurantSettings() {
        const restaurantData = {
            restaurant_name: document.querySelector('input[type="text"]').value,
            restaurant_email: document.querySelector('input[type="email"]').value,
            restaurant_phone: document.querySelector('input[type="tel"]').value
        };

        try {
            for (const [key, value] of Object.entries(restaurantData)) {
                await saveSetting(key, value, 'string');
            }
            alert('Pengaturan restoran berhasil disimpan!');
        } catch (error) {
            console.error('Error saving restaurant settings:', error);
            alert('Gagal menyimpan pengaturan restoran');
        }
    }

    // Save Tax & Service Settings
    async function saveTaxSettings() {
        const taxData = {
            tax_rate: (parseFloat(document.querySelectorAll('input[type="number"]')[0].value) / 100).toString(),
            service_charge: (parseFloat(document.querySelectorAll('input[type="number"]')[1].value) / 100).toString()
        };

        try {
            for (const [key, value] of Object.entries(taxData)) {
                await saveSetting(key, value, 'decimal');
            }
            alert('Pengaturan pajak berhasil disimpan!');
        } catch (error) {
            console.error('Error saving tax settings:', error);
            alert('Gagal menyimpan pengaturan pajak');
        }
    }

    // Save Payment Methods
    async function savePaymentMethods() {
        const paymentToggles = document.querySelectorAll('.setting-item input[type="checkbox"]');
        const paymentData = {
            payment_cash: paymentToggles[0].checked.toString(),
            payment_card: paymentToggles[1].checked.toString(),
            payment_qr: paymentToggles[2].checked.toString(),
            payment_transfer: paymentToggles[3].checked.toString()
        };

        try {
            for (const [key, value] of Object.entries(paymentData)) {
                await saveSetting(key, value, 'boolean');
            }
            alert('Metode pembayaran berhasil disimpan!');
        } catch (error) {
            console.error('Error saving payment methods:', error);
            alert('Gagal menyimpan metode pembayaran');
        }
    }

    // Save Notification Settings
    async function saveNotificationSettings() {
        const notifToggles = document.querySelectorAll('.setting-item input[type="checkbox"]');
        const offset = 4;
        const notifData = {
            notif_new_order: notifToggles[offset].checked.toString(),
            notif_low_stock: notifToggles[offset + 1].checked.toString(),
            notif_sound: notifToggles[offset + 2].checked.toString()
        };

        try {
            for (const [key, value] of Object.entries(notifData)) {
                await saveSetting(key, value, 'boolean');
            }
            alert('Pengaturan notifikasi berhasil disimpan!');
        } catch (error) {
            console.error('Error saving notification settings:', error);
            alert('Gagal menyimpan pengaturan notifikasi');
        }
    }

    // Save General Settings
    async function saveGeneralSettings() {
        alert('Pengaturan umum berhasil disimpan!');
    }

    // Generic Save Setting Function
    async function saveSetting(key, value, type) {
        try {
            const response = await fetch(`${API_BASE}/settings.php`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    key: key,
                    value: value,
                    type: type
                })
            });
            
            const result = await response.json();
            
            if (!result.success) {
                throw new Error(result.message);
            }
        } catch (error) {
            throw error;
        }
    }

    // Test Database Connection
    async function testDatabaseConnection() {
        try {
            const response = await fetch(`${API_BASE}/settings.php?action=test_db`);
            const result = await response.json();
            
            if (result.success) {
                alert('✓ Koneksi database berhasil!');
            } else {
                alert('✗ Koneksi database gagal: ' + result.message);
            }
        } catch (error) {
            console.error('Error testing database:', error);
            alert('✗ Gagal menguji koneksi database');
        }
    }

    // Add event listeners to save buttons
    document.addEventListener('DOMContentLoaded', () => {
        const saveButtons = document.querySelectorAll('.btn-primary');
        
        if (saveButtons[0]) saveButtons[0].onclick = saveRestaurantSettings;
        if (saveButtons[1]) saveButtons[1].onclick = saveTaxSettings;
        if (saveButtons[2]) saveButtons[2].onclick = savePaymentMethods;
        if (saveButtons[3]) saveButtons[3].onclick = saveNotificationSettings;
        if (saveButtons[4]) saveButtons[4].onclick = testDatabaseConnection;
        if (saveButtons[5]) saveButtons[5].onclick = saveGeneralSettings;
    });

    function logout() {
        if (confirm('Yakin ingin logout?')) {
            localStorage.removeItem('user');
            window.location.href = 'index.html';
        }
    }

    // Initial load
    fetchSettings();
</script>
