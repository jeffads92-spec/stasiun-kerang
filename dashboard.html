<!-- Ganti bagian <script> di dashboard.html dengan ini -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<script>
    // Check login
    const user = JSON.parse(localStorage.getItem('user'));
    if (!user) {
        window.location.href = 'index.html';
    }

    const API_BASE = '/api';

    // Set user info
    document.getElementById('userName').textContent = user.username;
    document.getElementById('userRole').textContent = user.role;
    document.getElementById('userAvatar').textContent = user.username.charAt(0).toUpperCase();

    // Fetch Dashboard Stats
    async function fetchDashboardStats() {
        try {
            const response = await fetch(`${API_BASE}/dashboard.php?action=stats`);
            const result = await response.json();
            
            if (result.success) {
                const data = result.data;
                document.getElementById('totalOrders').textContent = data.total_orders || 0;
                document.getElementById('totalRevenue').textContent = formatCurrency(data.total_revenue || 0);
                document.getElementById('activeOrders').textContent = data.active_orders || 0;
                document.getElementById('tableOccupancy').textContent = data.table_occupancy + '%' || '0%';
            }
        } catch (error) {
            console.error('Error fetching stats:', error);
            // Use dummy data if API fails
            generateDashboardData();
        }
    }

    // Fetch Sales Trend
    async function fetchSalesTrend() {
        try {
            const response = await fetch(`${API_BASE}/dashboard.php?action=sales&days=7`);
            const result = await response.json();
            
            if (result.success && result.data.trend) {
                updateSalesChart(result.data.trend);
                return;
            }
        } catch (error) {
            console.error('Error fetching sales trend:', error);
        }
        // Use dummy data if API fails
        updateSalesChart([
            {date: 'Sen', revenue: 2500000},
            {date: 'Sel', revenue: 3200000},
            {date: 'Rab', revenue: 2800000},
            {date: 'Kam', revenue: 4100000},
            {date: 'Jum', revenue: 3900000},
            {date: 'Sab', revenue: 5200000},
            {date: 'Min', revenue: 4800000}
        ]);
    }

    // Fetch Top Menu
    async function fetchTopMenu() {
        try {
            const response = await fetch(`${API_BASE}/dashboard.php?action=top_menu&limit=4`);
            const result = await response.json();
            
            if (result.success && result.data.top_menu) {
                renderTopMenu(result.data.top_menu);
                return;
            }
        } catch (error) {
            console.error('Error fetching top menu:', error);
        }
        // Use dummy data if API fails
        renderTopMenu([
            { name: 'Kerang Asam Manis', sales: 45, color: '#667eea' },
            { name: 'Udang Goreng Mentega', sales: 38, color: '#11998e' },
            { name: 'Cumi Saus Padang', sales: 32, color: '#f5576c' },
            { name: 'Kepiting Saos Tiram', sales: 28, color: '#4facfe' }
        ]);
    }

    // Fetch Recent Orders
    async function fetchRecentOrders() {
        try {
            const response = await fetch(`${API_BASE}/orders.php?limit=5`);
            const result = await response.json();
            
            if (result.success && result.data.orders) {
                renderRecentOrders(result.data.orders);
                return;
            }
        } catch (error) {
            console.error('Error fetching orders:', error);
        }
        // Use dummy data if API fails
        renderRecentOrders([
            { order_number: 'ORD-20260106-0001', table_number: 'T01', total_items: 3, total: 285000, status: 'completed', created_at: '10:30' },
            { order_number: 'ORD-20260106-0002', table_number: 'T03', total_items: 5, total: 520000, status: 'preparing', created_at: '11:15' },
            { order_number: 'ORD-20260106-0003', table_number: 'T05', total_items: 2, total: 180000, status: 'ready', created_at: '11:45' }
        ]);
    }

    function renderTopMenu(menuData) {
        const maxSales = Math.max(...menuData.map(m => m.sales || m.quantity));
        const topMenuHtml = menuData.map((item, index) => `
            <div style="margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                    <span style="font-weight: 600; color: #333;">${item.name || item.menu_name}</span>
                    <span style="color: #999;">${item.sales || item.quantity} porsi</span>
                </div>
                <div style="background: #f0f0f0; height: 8px; border-radius: 10px; overflow: hidden;">
                    <div style="background: ${item.color || '#667eea'}; height: 100%; width: ${((item.sales || item.quantity) / maxSales) * 100}%; border-radius: 10px;"></div>
                </div>
            </div>
        `).join('');
        document.getElementById('topMenu').innerHTML = topMenuHtml;
    }

    function renderRecentOrders(orders) {
        if (orders.length === 0) {
            document.getElementById('ordersTable').innerHTML = `
                <tr>
                    <td colspan="6" style="text-align: center; padding: 40px; color: #999;">
                        Tidak ada order hari ini
                    </td>
                </tr>
            `;
            return;
        }

        const ordersHtml = orders.map(order => `
            <tr>
                <td><strong>${order.order_number}</strong></td>
                <td>${order.table_number}</td>
                <td>${order.total_items} items</td>
                <td><strong>${formatCurrency(order.total)}</strong></td>
                <td><span class="badge badge-${order.status}">${order.status}</span></td>
                <td>${formatTime(order.created_at)}</td>
            </tr>
        `).join('');
        document.getElementById('ordersTable').innerHTML = ordersHtml;
    }

    function updateSalesChart(trendData) {
        const labels = trendData.map(d => d.date);
        const data = trendData.map(d => d.revenue);
        
        salesChart.data.labels = labels;
        salesChart.data.datasets[0].data = data;
        salesChart.update();
    }

    function formatCurrency(amount) {
        return 'Rp ' + amount.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, '.');
    }

    function formatTime(datetime) {
        if (!datetime) return '-';
        const date = new Date(datetime);
        return date.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
    }

    function generateDashboardData() {
        const orders = Math.floor(Math.random() * 50) + 20;
        const revenue = orders * (Math.random() * 150000 + 50000);
        const active = Math.floor(Math.random() * 15) + 5;
        const occupancy = Math.floor((active / 20) * 100);

        document.getElementById('totalOrders').textContent = orders;
        document.getElementById('totalRevenue').textContent = formatCurrency(revenue);
        document.getElementById('activeOrders').textContent = active;
        document.getElementById('tableOccupancy').textContent = occupancy + '%';
    }

    // Sales Chart
    const ctx = document.getElementById('salesChart').getContext('2d');
    const salesChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Penjualan',
                data: [],
                borderColor: '#667eea',
                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return 'Rp ' + (value / 1000000).toFixed(1) + 'jt';
                        }
                    }
                }
            }
        }
    });

    function logout() {
        if (confirm('Apakah Anda yakin ingin logout?')) {
            localStorage.removeItem('user');
            window.location.href = 'index.html';
        }
    }

    function showProfile() {
        alert('Fitur profil akan segera hadir!');
    }

    // Initial load
    fetchDashboardStats();
    fetchSalesTrend();
    fetchTopMenu();
    fetchRecentOrders();

    // Auto refresh every 30 seconds
    setInterval(() => {
        fetchDashboardStats();
        fetchRecentOrders();
    }, 30000);
</script>
