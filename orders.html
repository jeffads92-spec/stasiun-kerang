<!-- Ganti bagian <script> di orders.html dengan ini -->
<script>
    const user = JSON.parse(localStorage.getItem('user'));
    if (!user) window.location.href = 'index.html';

    const API_BASE = '/api';
    let orders = [];
    let menuItems = [];
    let selectedItems = [];
    let currentFilter = 'all';

    // Fetch Orders
    async function fetchOrders(status = null) {
        try {
            let url = `${API_BASE}/orders.php`;
            if (status && status !== 'all') {
                url += `?status=${status}`;
            }
            
            const response = await fetch(url);
            const result = await response.json();
            
            if (result.success) {
                orders = result.data.orders || [];
                renderOrders(currentFilter);
            } else {
                console.error('Failed to fetch orders:', result.message);
            }
        } catch (error) {
            console.error('Error fetching orders:', error);
        }
    }

    // Fetch Menu Items
    async function fetchMenuItems() {
        try {
            const response = await fetch(`${API_BASE}/menu.php?available=true`);
            const result = await response.json();
            
            if (result.success) {
                menuItems = result.data.items || [];
            }
        } catch (error) {
            console.error('Error fetching menu:', error);
        }
    }

    function renderOrders(filter = 'all') {
        const grid = document.getElementById('ordersGrid');
        const filteredOrders = filter === 'all' ? orders : orders.filter(o => o.status === filter);
        
        if (filteredOrders.length === 0) {
            grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 60px; color: #999;">Tidak ada order dengan status ini</div>';
            return;
        }
        
        grid.innerHTML = filteredOrders.map(order => `
            <div class="order-card">
                <div class="order-header">
                    <div>
                        <div class="order-number">${order.order_number}</div>
                        <div class="order-time"><i class="far fa-clock"></i> ${formatTime(order.created_at)}</div>
                    </div>
                    <span class="badge badge-${order.status}">${order.status}</span>
                </div>
                <div class="order-info">
                    <div class="info-row"><span class="info-label">Meja:</span><span class="info-value">${order.table_number || '-'}</span></div>
                    <div class="info-row"><span class="info-label">Pelanggan:</span><span class="info-value">${order.customer_name || 'Guest'}</span></div>
                    <div class="info-row"><span class="info-label">Tipe:</span><span class="info-value">${order.order_type || 'dine_in'}</span></div>
                </div>
                <div class="order-items">
                    ${(order.items || []).map(item => `
                        <div class="order-item">
                            <span>${item.quantity}x ${item.menu_name || item.name}</span>
                            <span><strong>${formatCurrency(item.price * item.quantity)}</strong></span>
                        </div>
                    `).join('')}
                </div>
                <div class="order-total">
                    <div class="total-row"><span>Total:</span><span>${formatCurrency(order.total)}</span></div>
                </div>
                <div class="order-actions">
                    ${order.status === 'pending' ? `<button class="btn btn-sm btn-info" onclick="updateOrderStatus(${order.id}, 'preparing')"><i class="fas fa-fire"></i> Mulai Masak</button>` : ''}
                    ${order.status === 'preparing' ? `<button class="btn btn-sm btn-success" onclick="updateOrderStatus(${order.id}, 'ready')"><i class="fas fa-check"></i> Siap</button>` : ''}
                    ${order.status === 'ready' ? `<button class="btn btn-sm btn-success" onclick="updateOrderStatus(${order.id}, 'completed')"><i class="fas fa-check-double"></i> Selesai</button>` : ''}
                    ${order.status !== 'cancelled' && order.status !== 'completed' ? `<button class="btn btn-sm btn-danger" onclick="cancelOrder(${order.id})"><i class="fas fa-times"></i> Batal</button>` : ''}
                </div>
            </div>
        `).join('');
    }

    function filterOrders(status) {
        currentFilter = status;
        document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        renderOrders(status);
    }

    function openNewOrderModal() {
        document.getElementById('newOrderModal').style.display = 'block';
        if (menuItems.length === 0) {
            fetchMenuItems().then(() => renderMenuSelector());
        } else {
            renderMenuSelector();
        }
    }

    function closeNewOrderModal() {
        document.getElementById('newOrderModal').style.display = 'none';
        document.getElementById('newOrderForm').reset();
        selectedItems = [];
    }

    function renderMenuSelector() {
        const selector = document.getElementById('menuSelector');
        selector.innerHTML = menuItems.map(item => `
            <div class="menu-item-card" data-id="${item.id}" onclick="toggleMenuItem(${item.id})">
                <div style="font-weight: 600; margin-bottom: 8px;">${item.name}</div>
                <div style="color: #667eea; font-weight: bold;">${formatCurrency(item.price)}</div>
                <div style="font-size: 12px; color: #999; margin-top: 5px;">${item.category_name || ''}</div>
            </div>
        `).join('');
    }

    function toggleMenuItem(itemId) {
        const card = event.currentTarget;
        const item = menuItems.find(m => m.id === itemId);
        const index = selectedItems.findIndex(s => s.id === itemId);
        
        if (index > -1) {
            selectedItems.splice(index, 1);
            card.classList.remove('selected');
        } else {
            selectedItems.push({
                menu_item_id: item.id,
                quantity: 1,
                price: item.price,
                notes: ''
            });
            card.classList.add('selected');
        }
    }

    document.getElementById('newOrderForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        if (selectedItems.length === 0) {
            alert('Pilih minimal 1 menu!');
            return;
        }
        
        const orderData = {
            table_number: document.getElementById('tableNumber').value,
            customer_name: document.getElementById('customerName').value || 'Guest',
            customer_phone: document.getElementById('customerPhone').value || '',
            user_id: user.id || 1,
            order_type: document.getElementById('orderType').value,
            items: selectedItems,
            notes: document.getElementById('orderNotes').value || ''
        };

        try {
            const response = await fetch(`${API_BASE}/orders.php`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(orderData)
            });
            
            const result = await response.json();
            
            if (result.success) {
                alert('Order berhasil dibuat! Order #' + result.data.order_number);
                closeNewOrderModal();
                fetchOrders();
            } else {
                alert('Error: ' + result.message);
            }
        } catch (error) {
            console.error('Error creating order:', error);
            alert('Gagal membuat order');
        }
    });

    async function updateOrderStatus(orderId, newStatus) {
        try {
            const response = await fetch(`${API_BASE}/orders.php?id=${orderId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status: newStatus })
            });
            
            const result = await response.json();
            
            if (result.success) {
                alert(`Order diupdate ke status: ${newStatus}`);
                fetchOrders();
            } else {
                alert('Error: ' + result.message);
            }
        } catch (error) {
            console.error('Error updating order:', error);
            alert('Gagal update order');
        }
    }

    async function cancelOrder(orderId) {
        if (confirm('Yakin ingin membatalkan order ini?')) {
            try {
                const response = await fetch(`${API_BASE}/orders.php?id=${orderId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('Order dibatalkan');
                    fetchOrders();
                } else {
                    alert('Error: ' + result.message);
                }
            } catch (error) {
                console.error('Error cancelling order:', error);
                alert('Gagal membatalkan order');
            }
        }
    }

    function formatCurrency(amount) {
        return 'Rp ' + amount.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, '.');
    }

    function formatTime(datetime) {
        if (!datetime) return '-';
        const date = new Date(datetime);
        return date.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
    }

    function logout() {
        if (confirm('Yakin ingin logout?')) {
            localStorage.removeItem('user');
            window.location.href = 'index.html';
        }
    }

    // Initial load
    fetchOrders();
    fetchMenuItems();

    // Auto refresh every 15 seconds
    setInterval(() => {
        fetchOrders();
    }, 15000);
</script>
