<!-- Ganti bagian <script> di menu-management.html dengan ini -->
<script>
    const user = JSON.parse(localStorage.getItem('user'));
    if (!user) window.location.href = 'index.html';

    const API_BASE = '/api';
    let menuItems = [];
    let categories = [];
    let currentCategory = 'all';
    let editingId = null;

    // Fetch Categories
    async function fetchCategories() {
        try {
            const response = await fetch(`${API_BASE}/menu.php?resource=categories`);
            const result = await response.json();
            
            if (result.success) {
                categories = [
                    { id: 'all', name: 'Semua Menu', icon: 'ðŸ½ï¸' },
                    ...result.data.categories.map(cat => ({
                        id: cat.id,
                        name: cat.name,
                        icon: cat.icon || 'ðŸ½ï¸'
                    }))
                ];
                renderCategories();
            }
        } catch (error) {
            console.error('Error fetching categories:', error);
            // Use default categories
            categories = [
                { id: 'all', name: 'Semua Menu', icon: 'ðŸ½ï¸' },
                { id: 'seafood', name: 'Seafood', icon: 'ðŸ¦' },
                { id: 'kerang', name: 'Kerang Special', icon: 'ðŸ¦ª' }
            ];
            renderCategories();
        }
    }

    // Fetch Menu Items
    async function fetchMenuItems() {
        try {
            let url = `${API_BASE}/menu.php`;
            if (currentCategory !== 'all') {
                url += `?category=${currentCategory}`;
            }
            
            const response = await fetch(url);
            const result = await response.json();
            
            if (result.success) {
                menuItems = result.data.items || [];
                renderMenu();
            }
        } catch (error) {
            console.error('Error fetching menu:', error);
        }
    }

    function renderCategories() {
        const tabs = document.getElementById('categoryTabs');
        tabs.innerHTML = categories.map(cat => `
            <button class="tab-btn ${currentCategory === cat.id ? 'active' : ''}" onclick="filterByCategory('${cat.id}')">
                ${cat.icon} ${cat.name}
            </button>
        `).join('');
    }

    function filterByCategory(categoryId) {
        currentCategory = categoryId;
        renderCategories();
        fetchMenuItems();
    }

    function renderMenu() {
        const grid = document.getElementById('menuGrid');
        let filtered = menuItems;
        
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        if (searchTerm) {
            filtered = filtered.filter(m => 
                m.name.toLowerCase().includes(searchTerm) || 
                (m.description && m.description.toLowerCase().includes(searchTerm))
            );
        }

        if (filtered.length === 0) {
            grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 60px; color: #999;"><i class="fas fa-utensils" style="font-size: 60px; opacity: 0.3; margin-bottom: 20px;"></i><h3>Tidak ada menu ditemukan</h3></div>';
            return;
        }

        grid.innerHTML = filtered.map(item => `
            <div class="menu-card">
                <div class="menu-image">
                    ${getMenuEmoji(item.category_name)}
                    <span class="menu-badge ${item.is_available ? 'badge-available' : 'badge-unavailable'}">
                        ${item.is_available ? 'âœ“ Tersedia' : 'âœ— Habis'}
                    </span>
                </div>
                <div class="menu-body">
                    <div class="menu-name">${item.name}</div>
                    <div class="menu-description">${item.description || '-'}</div>
                    <div class="menu-price">${formatCurrency(item.price)}</div>
                    <div class="menu-meta">
                        <span><i class="fas fa-clock"></i> ${item.preparation_time || 15} min</span>
                        <span><i class="fas fa-fire"></i> ${getSpicyLabel(item.spicy_level)}</span>
                        <span><i class="fas fa-bolt"></i> ${item.calories || 0} kcal</span>
                    </div>
                    <div class="menu-actions">
                        <button class="btn btn-sm btn-info" onclick="editMenu(${item.id})">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="btn btn-sm ${item.is_available ? 'btn-warning' : 'btn-success'}" onclick="toggleAvailability(${item.id})">
                            <i class="fas fa-${item.is_available ? 'eye-slash' : 'eye'}"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteMenu(${item.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `).join('');
    }

    function getMenuEmoji(category) {
        const emojis = {
            'Seafood': 'ðŸ¦',
            'Kerang': 'ðŸ¦ª',
            'Appetizers': 'ðŸ¥—',
            'Main': 'ðŸ›',
            'Beverages': 'ðŸ¥¤',
            'Desserts': 'ðŸ°'
        };
        return emojis[category] || 'ðŸ½ï¸';
    }

    function getSpicyLabel(level) {
        const labels = {
            'none': 'Tidak Pedas',
            'mild': 'Pedas Ringan',
            'medium': 'Sedang',
            'hot': 'Pedas',
            'very_hot': 'Sangat Pedas'
        };
        return labels[level] || 'Tidak Pedas';
    }

    function formatCurrency(amount) {
        return 'Rp ' + amount.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, '.');
    }

    function searchMenu() {
        renderMenu();
    }

    function openAddModal() {
        editingId = null;
        document.getElementById('modalTitle').textContent = 'Tambah Menu Baru';
        document.getElementById('menuForm').reset();
        document.getElementById('menuAvailable').checked = true;
        document.getElementById('imagePreview').style.display = 'none';
        document.getElementById('menuModal').style.display = 'block';
    }

    async function editMenu(id) {
        try {
            const response = await fetch(`${API_BASE}/menu.php?id=${id}`);
            const result = await response.json();
            
            if (result.success) {
                editingId = id;
                const item = result.data.item;
                document.getElementById('modalTitle').textContent = 'Edit Menu';
                document.getElementById('menuId').value = item.id;
                document.getElementById('menuName').value = item.name;
                document.getElementById('menuCategory').value = item.category_id;
                document.getElementById('menuPrice').value = item.price;
                document.getElementById('menuCost').value = item.cost_price || 0;
                document.getElementById('menuDescription').value = item.description || '';
                document.getElementById('menuPrepTime').value = item.preparation_time || 15;
                document.getElementById('menuSpicy').value = item.spicy_level || 'none';
                document.getElementById('menuCalories').value = item.calories || 0;
                document.getElementById('menuStock').value = item.stock_quantity || 0;
                document.getElementById('menuAvailable').checked = item.is_available;
                document.getElementById('menuFeatured').checked = item.is_featured;
                document.getElementById('menuModal').style.display = 'block';
            }
        } catch (error) {
            console.error('Error fetching menu item:', error);
            alert('Gagal memuat data menu');
        }
    }

    function closeModal() {
        document.getElementById('menuModal').style.display = 'none';
    }

    function previewImage() {
        const file = document.getElementById('menuImage').files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.getElementById('imagePreview');
                preview.src = e.target.result;
                preview.style.display = 'block';
            };
            reader.readAsDataURL(file);
        }
    }

    document.getElementById('menuForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const formData = {
            category_id: parseInt(document.getElementById('menuCategory').value),
            name: document.getElementById('menuName').value,
            description: document.getElementById('menuDescription').value,
            price: parseFloat(document.getElementById('menuPrice').value),
            cost_price: parseFloat(document.getElementById('menuCost').value) || 0,
            preparation_time: parseInt(document.getElementById('menuPrepTime').value),
            spicy_level: document.getElementById('menuSpicy').value,
            calories: parseInt(document.getElementById('menuCalories').value) || 0,
            stock_quantity: parseInt(document.getElementById('menuStock').value) || null,
            is_available: document.getElementById('menuAvailable').checked,
            is_featured: document.getElementById('menuFeatured').checked
        };

        try {
            const method = editingId ? 'PUT' : 'POST';
            const url = editingId ? `${API_BASE}/menu.php?id=${editingId}` : `${API_BASE}/menu.php`;
            
            const response = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            });
            
            const result = await response.json();
            
            if (result.success) {
                alert(editingId ? 'Menu berhasil diupdate!' : 'Menu berhasil ditambahkan!');
                closeModal();
                fetchMenuItems();
            } else {
                alert('Error: ' + result.message);
            }
        } catch (error) {
            console.error('Error saving menu:', error);
            alert('Gagal menyimpan menu');
        }
    });

    async function toggleAvailability(id) {
        try {
            const item = menuItems.find(m => m.id === id);
            const response = await fetch(`${API_BASE}/menu.php?id=${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ is_available: !item.is_available })
            });
            
            const result = await response.json();
            
            if (result.success) {
                alert(`Menu ${item.name} ${!item.is_available ? 'tersedia' : 'tidak tersedia'}`);
                fetchMenuItems();
            } else {
                alert('Error: ' + result.message);
            }
        } catch (error) {
            console.error('Error toggling availability:', error);
            alert('Gagal update status menu');
        }
    }

    async function deleteMenu(id) {
        if (confirm('Yakin ingin menghapus menu ini?')) {
            try {
                const response = await fetch(`${API_BASE}/menu.php?id=${id}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('Menu berhasil dihapus!');
                    fetchMenuItems();
                } else {
                    alert('Error: ' + result.message);
                }
            } catch (error) {
                console.error('Error deleting menu:', error);
                alert('Gagal menghapus menu');
            }
        }
    }

    function logout() {
        if (confirm('Yakin ingin logout?')) {
            localStorage.removeItem('user');
            window.location.href = 'index.html';
        }
    }

    // Initial load
    fetchCategories();
    fetchMenuItems();
</script>
