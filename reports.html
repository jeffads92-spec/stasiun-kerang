<!-- Ganti bagian <script> di reports.html dengan ini -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<script>
    const user = JSON.parse(localStorage.getItem('user'));
    if (!user) window.location.href = 'index.html';

    const API_BASE = '/api';
    let salesTrendChart, categoryChart;

    // Set default dates
    document.getElementById('startDate').value = new Date(Date.now() - 7*24*60*60*1000).toISOString().split('T')[0];
    document.getElementById('endDate').value = new Date().toISOString().split('T')[0];

    // Fetch Report Summary
    async function fetchReportSummary() {
        try {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            const response = await fetch(`${API_BASE}/reports.php?action=summary&start_date=${startDate}&end_date=${endDate}`);
            const result = await response.json();
            
            if (result.success) {
                renderSummary(result.data.summary);
            }
        } catch (error) {
            console.error('Error fetching summary:', error);
            renderDefaultSummary();
        }
    }

    function renderSummary(summary) {
        document.querySelector('.stats-summary').innerHTML = `
            <div class="summary-card">
                <div class="summary-icon blue">
                    <i class="fas fa-shopping-cart"></i>
                </div>
                <div class="summary-value">${summary.total_transactions || 0}</div>
                <div class="summary-label">Total Transaksi</div>
                <div class="summary-change change-positive">
                    <i class="fas fa-arrow-up"></i> +${summary.transaction_change || 0}% dari periode sebelumnya
                </div>
            </div>
            <div class="summary-card">
                <div class="summary-icon green">
                    <i class="fas fa-dollar-sign"></i>
                </div>
                <div class="summary-value">${formatCurrencyShort(summary.total_revenue || 0)}</div>
                <div class="summary-label">Total Revenue</div>
                <div class="summary-change change-positive">
                    <i class="fas fa-arrow-up"></i> +${summary.revenue_change || 0}% dari periode sebelumnya
                </div>
            </div>
            <div class="summary-card">
                <div class="summary-icon orange">
                    <i class="fas fa-chart-line"></i>
                </div>
                <div class="summary-value">${formatCurrencyShort(summary.average_transaction || 0)}</div>
                <div class="summary-label">Rata-rata Transaksi</div>
                <div class="summary-change change-positive">
                    <i class="fas fa-arrow-up"></i> +${summary.avg_change || 0}% dari periode sebelumnya
                </div>
            </div>
            <div class="summary-card">
                <div class="summary-icon purple">
                    <i class="fas fa-users"></i>
                </div>
                <div class="summary-value">${summary.unique_customers || 0}</div>
                <div class="summary-label">Total Pelanggan</div>
                <div class="summary-change change-positive">
                    <i class="fas fa-arrow-up"></i> +${summary.customer_change || 0}% dari periode sebelumnya
                </div>
            </div>
        `;
    }

    function renderDefaultSummary() {
        renderSummary({
            total_transactions: 248,
            total_revenue: 28500000,
            average_transaction: 115000,
            unique_customers: 186,
            transaction_change: 15.3,
            revenue_change: 22.8,
            avg_change: 6.5,
            customer_change: 12.1
        });
    }

    // Fetch Sales Trend
    async function fetchSalesTrend() {
        try {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            const response = await fetch(`${API_BASE}/reports.php?action=sales_trend&start_date=${startDate}&end_date=${endDate}`);
            const result = await response.json();
            
            if (result.success && result.data.trend) {
                updateSalesTrendChart(result.data.trend);
            }
        } catch (error) {
            console.error('Error fetching sales trend:', error);
        }
    }

    function updateSalesTrendChart(trendData) {
        const labels = trendData.map(d => d.date);
        const data = trendData.map(d => d.revenue);
        
        if (salesTrendChart) {
            salesTrendChart.data.labels = labels;
            salesTrendChart.data.datasets[0].data = data;
            salesTrendChart.update();
        }
    }

    // Fetch Menu Performance
    async function fetchMenuPerformance() {
        try {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            const response = await fetch(`${API_BASE}/reports.php?action=menu_performance&start_date=${startDate}&end_date=${endDate}&limit=5`);
            const result = await response.json();
            
            if (result.success && result.data.menu_performance) {
                renderTopMenu(result.data.menu_performance);
            }
        } catch (error) {
            console.error('Error fetching menu performance:', error);
            renderDefaultTopMenu();
        }
    }

    function renderTopMenu(menuData) {
        const maxQty = Math.max(...menuData.map(m => m.quantity));
        const topMenuHtml = menuData.map((item, index) => {
            const percentage = (item.quantity / maxQty) * 100;
            return `
                <div style="margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="font-weight: 600; color: #333;">${index + 1}. ${item.menu_name}</span>
                        <span style="color: #667eea; font-weight: bold;">${item.quantity} porsi</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; font-size: 13px; color: #999; margin-bottom: 8px;">
                        <span>Revenue: ${formatCurrency(item.total_revenue)}</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${percentage}%;"></div>
                    </div>
                </div>
            `;
        }).join('');
        document.getElementById('topSellingMenu').innerHTML = topMenuHtml;
    }

    function renderDefaultTopMenu() {
        renderTopMenu([
            { menu_name: 'Kerang Asam Manis', quantity: 85, total_revenue: 7225000 },
            { menu_name: 'Udang Goreng Mentega', quantity: 72, total_revenue: 6840000 },
            { menu_name: 'Cumi Saus Padang', quantity: 68, total_revenue: 5304000 },
            { menu_name: 'Kepiting Saos Tiram', quantity: 42, total_revenue: 6300000 },
            { menu_name: 'Kerang Hijau Kuah', quantity: 56, total_revenue: 3640000 }
        ]);
    }

    // Fetch Category Breakdown
    async function fetchCategoryBreakdown() {
        try {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            const response = await fetch(`${API_BASE}/reports.php?action=category_breakdown&start_date=${startDate}&end_date=${endDate}`);
            const result = await response.json();
            
            if (result.success && result.data.categories) {
                updateCategoryChart(result.data.categories);
            }
        } catch (error) {
            console.error('Error fetching category breakdown:', error);
        }
    }

    function updateCategoryChart(categories) {
        if (categoryChart) {
            categoryChart.data.labels = categories.map(c => c.category_name);
            categoryChart.data.datasets[0].data = categories.map(c => c.percentage);
            categoryChart.update();
        }
    }

    // Fetch Transactions
    async function fetchTransactions() {
        try {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            const response = await fetch(`${API_BASE}/reports.php?action=transactions&start_date=${startDate}&end_date=${endDate}`);
            const result = await response.json();
            
            if (result.success && result.data.transactions) {
                renderTransactions(result.data.transactions);
            }
        } catch (error) {
            console.error('Error fetching transactions:', error);
            renderDefaultTransactions();
        }
    }

    function renderTransactions(transactions) {
        const tableHtml = transactions.map(tx => `
            <tr>
                <td><strong>${tx.order_number}</strong></td>
                <td>${formatDateTime(tx.created_at)}</td>
                <td>${tx.customer_name || 'Guest'}</td>
                <td>${tx.table_number || '-'}</td>
                <td>${tx.total_items} items</td>
                <td><strong>${formatCurrency(tx.total)}</strong></td>
                <td><span style="padding: 4px 10px; background: #d1e7dd; color: #0f5132; border-radius: 4px; font-size: 12px;">${tx.payment_method || 'Cash'}</span></td>
                <td><span style="padding: 4px 10px; background: #d3d3d3; color: #383838; border-radius: 4px; font-size: 12px;">${tx.status}</span></td>
            </tr>
        `).join('');
        document.getElementById('transactionTable').innerHTML = tableHtml;
    }

    function renderDefaultTransactions() {
        renderTransactions([
            { order_number: 'ORD-20260106-0001', created_at: '2026-01-06 10:30:00', customer_name: 'John Doe', table_number: 'T01', total_items: 3, total: 285000, payment_method: 'Cash', status: 'completed' },
            { order_number: 'ORD-20260106-0002', created_at: '2026-01-06 11:15:00', customer_name: 'Jane Smith', table_number: 'T03', total_items: 5, total: 520000, payment_method: 'Card', status: 'completed' },
            { order_number: 'ORD-20260106-0003', created_at: '2026-01-06 11:45:00', customer_name: 'Bob Wilson', table_number: 'T05', total_items: 2, total: 180000, payment_method: 'QR Code', status: 'completed' }
        ]);
    }

    // Initialize Charts
    const ctx1 = document.getElementById('salesTrendChart').getContext('2d');
    salesTrendChart = new Chart(ctx1, {
        type: 'line',
        data: {
            labels: ['1 Jan', '2 Jan', '3 Jan', '4 Jan', '5 Jan', '6 Jan'],
            datasets: [{
                label: 'Revenue',
                data: [3800000, 4200000, 3900000, 5100000, 4800000, 6700000],
                borderColor: '#667eea',
                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                tension: 0.4,
                fill: true,
                pointRadius: 6,
                pointHoverRadius: 8
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return 'Rp ' + context.parsed.y.toLocaleString('id-ID');
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return 'Rp ' + (value / 1000000) + 'M';
                        }
                    }
                }
            }
        }
    });

    const ctx2 = document.getElementById('categoryChart').getContext('2d');
    categoryChart = new Chart(ctx2, {
        type: 'doughnut',
        data: {
            labels: ['Seafood', 'Kerang Special', 'Appetizers', 'Beverages'],
            datasets: [{
                data: [45, 30, 15, 10],
                backgroundColor: ['#667eea', '#11998e', '#f5576c', '#4facfe'],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });

    function formatCurrency(amount) {
        return 'Rp ' + amount.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, '.');
    }

    function formatCurrencyShort(amount) {
        if (amount >= 1000000) {
            return 'Rp ' + (amount / 1000000).toFixed(1) + 'M';
        }
        return 'Rp ' + (amount / 1000).toFixed(0) + 'K';
    }

    function formatDateTime(datetime) {
        if (!datetime) return '-';
        const date = new Date(datetime);
        return date.toLocaleDateString('id-ID') + ' ' + date.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
    }

    function generateReport() {
        fetchReportSummary();
        fetchSalesTrend();
        fetchMenuPerformance();
        fetchCategoryBreakdown();
        fetchTransactions();
    }

    async function exportReport() {
        try {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const format = 'csv';
            
            const response = await fetch(`${API_BASE}/reports.php?action=export&format=${format}&start_date=${startDate}&end_date=${endDate}`);
            
            if (response.ok) {
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `report_${startDate}_${endDate}.${format}`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                a.remove();
                alert('Report berhasil di-export!');
            } else {
                alert('Gagal export report');
            }
        } catch (error) {
            console.error('Error exporting report:', error);
            alert('Gagal export report');
        }
    }

    function switchTab(tab) {
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        console.log(`Switched to ${tab} view`);
    }

    function logout() {
        if (confirm('Yakin ingin logout?')) {
            localStorage.removeItem('user');
            window.location.href = 'index.html';
        }
    }

    // Initial load
    fetchReportSummary();
    fetchSalesTrend();
    fetchMenuPerformance();
    fetchCategoryBreakdown();
    fetchTransactions();
</script>
